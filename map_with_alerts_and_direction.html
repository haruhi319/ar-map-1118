
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 水路通報マップ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <style>
        #map { height: 100vh; }
        .info-box { position: absolute; top: 10px; left: 10px; background-color: rgba(255, 255, 255, 0.7); padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info-box" class="info-box"></div>

    <script>
        var map = L.map('map').setView([35.5, 139.8], 10); // 初期の地図位置設定

        // OpenStreetMapタイルレイヤーの設定
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var userLat = null;
        var userLon = null;

        // ユーザーの位置情報を取得
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;

                    // ユーザーの位置を地図にマーカーとして追加
                    var userMarker = L.marker([userLat, userLon]).addTo(map);
                    userMarker.bindPopup("現在位置").openPopup();

                    // ユーザーから近い情報をポップアップで表示
                    showNearbyInfo(userLat, userLon);
                }, function(error) {
                    alert("位置情報の取得に失敗しました: " + error.message);
                });
            } else {
                alert("このブラウザは位置情報に対応していません");
            }
        }

        // 100メートル以内の情報をポップアップで表示する関数
        function showNearbyInfo(userLat, userLon) {
            var nearbyInfo = [];
            var distanceThreshold = 100;  // 100メートル以内の情報を表示

            // 水路通報の情報を処理
            var alerts = ["\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u9632\u6ce2\u5824\u4e00\u90e8\u5012\u58ca", "\u9632\u6ce2\u5824\u4e00\u90e8\u5012\u58ca", "\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u7c21\u6613\u6a19\u8b58\u706f\u6d88\u706f\u3001\u4eee\u706f\u8a2d\u7f6e", "\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u30c9\u30eb\u30d5\u30a3\u30f3\u4e0d\u5b58\u5728", "\u706f\u4ed8\u30d6\u30a4\u6d88\u706f\u3001\u4eee\u706f\u8a2d\u7f6e", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6c88\u8239\u5b58\u5728", "\u706f\u4ed8\u30d6\u30a4\u6d88\u706f", "\u30c9\u30eb\u30d5\u30a3\u30f3\u306b\u3064\u3044\u3066", "\u30c9\u30eb\u30d5\u30a3\u30f3\u306b\u3064\u3044\u3066", "\u30c9\u30eb\u30d5\u30a3\u30f3\u4e0d\u5b58\u5728", "\u6c88\u8239\u5b58\u5728", "\u6c34\u6df1\u6e1b\u5c11\u53ca\u3073\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u706f\u4ed8\u30d6\u30a4\u6d41\u5931\u7b49", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u8a2d\u7f6e", "\u6d6e\u685f\u6a4b\u7b49\u8a2d\u7f6e", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6c88\u8239\u5b58\u5728", "\u6c88\u8239\u5b58\u5728", "\u6f01\u5177\u8a2d\u7f6e", "\u6c34\u6df1\u6e1b\u5c11\u3001\u6d45\u6240\u53ca\u3073\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6c34\u6df1\u6e1b\u5c11\u3001\u6d45\u6240\u53ca\u3073\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u4fe1\u53f7\u6240\u79fb\u8a2d", "\u6c34\u6df1\u6e1b\u5c11\u3001\u6d45\u6240\u53ca\u3073\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6c34\u6df1\u6e1b\u5c11\u3001\u6d45\u6240\u53ca\u3073\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u8b77\u5cb8\u6539\u826f\u5de5\u4e8b", "\u8b77\u5cb8\u6539\u826f\u5de5\u4e8b", "\u706f\u53f0\u5ec3\u6b62", "\u706f\u53f0\u5ec3\u6b62", "\u706f\u6a19\u7b49\u70b9\u691c\u4f5c\u696d", "\u706f\u6a19\u7b49\u70b9\u691c\u4f5c\u696d", "\u706f\u6a19\u7b49\u70b9\u691c\u4f5c\u696d", "\u706f\u6a19\u7b49\u70b9\u691c\u4f5c\u696d", "\u706f\u6a19\u7b49\u70b9\u691c\u4f5c\u696d", "\u706f\u6a19\u7b49\u70b9\u691c\u4f5c\u696d", "\u8b77\u5cb8\u88dc\u4fee\u5de5\u4e8b", "\u6d88\u6ce2\u30d6\u30ed\u30c3\u30af\u64a4\u53bb\u4f5c\u696d\u7b49", "\u30b7\u30fc\u30d0\u30fc\u30b9\u706f\u5149\u9054\u8ddd\u96e2\u5909\u66f4", "\u30b7\u30fc\u30d0\u30fc\u30b9\u706f\u5149\u9054\u8ddd\u96e2\u5909\u66f4", "\u30b7\u30fc\u30d0\u30fc\u30b9\u706f\u5149\u9054\u8ddd\u96e2\u5909\u66f4", "\u30b7\u30fc\u30d0\u30fc\u30b9\u706f\u5149\u9054\u8ddd\u96e2\u5909\u66f4", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6d45\u6240\u5b58\u5728", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u6f01\u5177\u8a2d\u7f6e", "\u30bf\u30f3\u30af\u4e0d\u5b58\u5728", "\u706f\u53f0\u5149\u9054\u8ddd\u96e2\u5909\u66f4", "\u6f01\u5177\u8a2d\u7f6e", "\u706f\u6d6e\u6a19\u4ea4\u63db\u4f5c\u696d", "\u706f\u6d6e\u6a19\u4ea4\u63db\u4f5c\u696d", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6d6e\u6a19\u5fa9\u65e7", "\u74b0\u5883\u8abf\u67fb", "\u74b0\u5883\u8abf\u67fb", "\u74b0\u5883\u8abf\u67fb", "\u74b0\u5883\u8abf\u67fb", "\u74b0\u5883\u8abf\u67fb", "\u74b0\u5883\u8abf\u67fb", "\u9577\u5927\u7269\u4ef6\u3048\u3044\u822a\u4f5c\u696d\u7b49", "\u6d45\u6240\u3001\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u9b5a\u7901\u5b58\u5728", "\u6d45\u6240\u3001\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u9b5a\u7901\u5b58\u5728", "\u6d45\u6240\u3001\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u9b5a\u7901\u5b58\u5728", "\u6d45\u6240\u3001\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u9b5a\u7901\u5b58\u5728", "\u6d45\u6240\u3001\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u9b5a\u7901\u5b58\u5728", "\u6d45\u6240\u3001\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u9b5a\u7901\u5b58\u5728", "\u6d45\u6240\u3001\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u9b5a\u7901\u5b58\u5728", "\u706f\u4ed8\u30d6\u30a4\u4e0d\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u6d45\u6240\u5b58\u5728", "\u6c34\u4e2d\u969c\u5bb3\u7269\u53ca\u3073\u6d45\u6240\u5b58\u5728", "\u706f\u4ed8\u6d6e\u6a19\u88dc\u4fee\u4f5c\u696d", "\u706f\u4ed8\u6d6e\u6a19\u88dc\u4fee\u4f5c\u696d", "\u91cd\u91cf\u7269\u8377\u5f79\u4f5c\u696d\u7b49", "\u6398\u4e0b\u3052\u4f5c\u696d", "\u5cb8\u58c1\u7bc9\u9020\u5de5\u4e8b", "\u5cb8\u58c1\u7bc9\u9020\u5de5\u4e8b", "\u5cb8\u58c1\u7bc9\u9020\u5de5\u4e8b", "\u6d41\u901f\u8a08\u8a2d\u7f6e", "\u706f\u6a19\u70b9\u691c\u4f5c\u696d", "\u7acb\u6a19\u4e0d\u5b58\u5728", "\u706f\u4ed8\u30d6\u30a4\u5fa9\u65e7", "\u706f\u4ed8\u30d6\u30a4\u5fa9\u65e7", "\u8b77\u5cb8\u6539\u826f\u5de5\u4e8b", "\u91cd\u91cf\u7269\u8377\u5f79\u4f5c\u696d\u7b49", "\u89b3\u6e2c\u6a5f\u5668\u8a2d\u7f6e", "\u6a4b\u6881\u67b6\u8a2d\u5de5\u4e8b", "\u6c34\u4e2d\u969c\u5bb3\u7269\u5b58\u5728", "\u685f\u6a4b\u7b49\u64a4\u53bb\u5de5\u4e8b", "\u6c34\u9580\u6539\u4fee\u5de5\u4e8b", "\u7acb\u6a19\u5012\u58ca", "\u8b77\u5cb8\u7bc9\u9020\u5de5\u4e8b"];  // JSONから水路通報の情報をここに追加
            var alertCoordinates = [[35.55540000000008, 140.08730000000003], [35.51630000000006, 140.03700000000003], [35.51350000000008, 140.03290000000004], [35.479100000000074, 139.76290000000006], [35.293300000000045, 139.75], [35.647800000000075, 139.99120000000005], [35.64690000000007, 139.9892000000001], [35.47610000000009, 139.99670000000003], [35.64690000000007, 139.9892000000001], [35.376100000000065, 139.6844000000001], [35.48580000000004, 139.78410000000008], [35.67930000000007, 139.9592], [35.39990000000006, 139.62790000000007], [35.38500000000005, 139.87830000000008], [35.544700000000034, 140.06000000000006], [35.623300000000086, 139.8221000000001], [35.62160000000006, 139.80950000000007], [35.485600000000034, 139.78390000000002], [35.38500000000005, 139.87830000000008], [35.33490000000006, 139.65300000000002], [35.48500000000007, 139.91500000000008], [35.22440000000006, 139.7211000000001], [35.48500000000007, 139.91500000000008], [35.62560000000008, 140.0163], [35.626700000000085, 140.0177000000001], [35.62790000000007, 140.0191000000001], [35.628900000000044, 140.0204], [35.62790000000007, 140.0217], [35.626700000000085, 140.0231], [35.62560000000008, 140.0245000000001], [35.62450000000007, 140.0231], [35.62340000000006, 140.0217], [35.62230000000005, 140.0204], [35.62340000000006, 140.0191000000001], [35.624600000000044, 140.0177000000001], [35.58220000000006, 139.7509], [35.546700000000044, 140.0281], [35.54500000000007, 140.06500000000005], [35.66470000000004, 139.99470000000008], [35.66480000000007, 139.9951000000001], [35.66470000000004, 139.99540000000002], [35.664900000000046, 139.99570000000006], [35.664900000000046, 139.99630000000002], [35.664900000000046, 139.9968], [35.66510000000005, 139.99740000000008], [35.66500000000008, 139.9977], [35.66510000000005, 139.99800000000005], [35.665200000000084, 139.9986], [35.665200000000084, 139.99890000000005], [35.664900000000046, 139.99880000000007], [35.546700000000044, 140.0281], [35.664900000000046, 139.99570000000006], [35.66500000000008, 139.9977], [35.665200000000084, 139.99890000000005], [35.28670000000005, 139.51170000000002], [35.28670000000005, 139.51170000000002], [35.32040000000006, 139.80740000000003], [35.55180000000007, 140.06380000000001], [35.553300000000036, 140.06370000000004], [35.45170000000007, 139.6414000000001], [35.553300000000036, 140.06370000000004], [35.55180000000007, 140.06380000000001], [35.552200000000084, 140.03500000000008], [35.25500000000005, 139.74720000000002], [35.24560000000008, 139.7392000000001], [35.241100000000074, 139.73580000000004], [35.238600000000076, 139.72940000000006], [35.235600000000034, 139.7278], [35.22580000000005, 139.73030000000006], [35.22280000000006, 139.7242], [35.22720000000004, 139.7197000000001], [35.22530000000006, 139.71530000000007], [35.22060000000005, 139.7206000000001], [35.20250000000004, 139.6839], [35.19610000000006, 139.67560000000003], [35.552200000000084, 140.03500000000008], [35.54500000000007, 140.06500000000005], [35.636700000000076, 139.80640000000005], [35.658600000000035, 139.7822000000001], [35.65810000000005, 139.78140000000008], [35.48470000000009, 139.7092], [35.48610000000008, 139.7125000000001], [35.46950000000004, 139.8668], [35.46490000000006, 139.87220000000002], [35.466000000000065, 139.87080000000003], [35.46690000000007, 139.8718], [35.46610000000004, 139.87330000000009], [35.46440000000007, 139.87440000000004], [35.598100000000045, 139.82640000000004], [35.58690000000007, 139.8025], [35.470900000000086, 139.7392000000001], [35.47060000000005, 139.73890000000006], [35.470800000000054, 139.73890000000006], [35.470800000000054, 139.73890000000006], [35.551600000000064, 140.11390000000006], [35.55170000000004, 140.1124000000001], [35.551900000000046, 140.11180000000002], [35.551900000000046, 140.1115000000001], [35.55180000000007, 140.11110000000008], [35.551600000000064, 140.11170000000004], [35.55130000000008, 140.1114], [35.55120000000005, 140.11090000000002], [35.55080000000004, 140.1115000000001], [35.55000000000007, 140.11350000000004], [35.33720000000005, 139.65390000000002], [35.33420000000007, 139.64170000000001], [35.333300000000065, 139.6431], [35.47280000000006, 139.67830000000004], [35.44810000000007, 139.6939000000001], [35.34480000000008, 139.7972000000001], [35.36170000000004, 139.88330000000008], [35.37000000000006, 139.8333], [35.33780000000007, 139.67470000000003], [35.48390000000006, 139.6953000000001], [35.29220000000004, 139.65110000000004], [35.28610000000009, 139.65780000000007], [35.29280000000006, 139.66250000000002], [35.30030000000005, 139.6586000000001], [35.30690000000004, 139.6722000000001], [35.31670000000008, 139.66560000000004], [35.49940000000004, 139.74530000000004], [35.24070000000006, 139.8297], [35.23760000000004, 139.8279], [35.23720000000009, 139.8257000000001], [35.222300000000075, 139.82760000000007], [35.220900000000086, 139.8257000000001], [35.21920000000006, 139.82490000000007], [35.244000000000085, 139.836], [35.40440000000007, 139.66140000000007], [35.509400000000085, 139.7572], [35.244000000000085, 139.836], [35.24070000000006, 139.8297], [35.23760000000004, 139.8279], [35.23720000000009, 139.8257000000001], [35.222300000000075, 139.82760000000007], [35.220900000000086, 139.8257000000001], [35.21920000000006, 139.82490000000007], [35.38220000000007, 139.9086000000001], [35.38140000000004, 139.9094], [35.43390000000005, 139.67860000000007], [35.34890000000007, 139.85750000000007], [35.59190000000007, 140.10720000000003], [35.59350000000006, 140.10540000000003], [35.59420000000006, 140.10580000000004], [35.489400000000046, 139.99390000000005], [35.36830000000003, 139.7600000000001], [35.282700000000034, 139.70100000000002], [35.512800000000084, 140.0336000000001], [35.512200000000064, 140.03390000000002], [35.657200000000046, 139.81080000000009], [35.468900000000076, 139.67330000000004], [35.62500000000006, 139.98670000000004], [35.65030000000007, 139.7581], [35.33780000000007, 139.67460000000005], [35.45920000000007, 139.9675000000001], [35.66330000000005, 139.7939], [35.282700000000034, 139.70100000000002], [35.68110000000007, 139.9819]];  // 位置情報
            for (var i = 0; i < alertCoordinates.length; i++) {
                var alertCoord = alertCoordinates[i];
                var alertName = alerts[i];
                var alertDistance = getDistance(userLat, userLon, alertCoord[0], alertCoord[1]);
                if (alertDistance <= distanceThreshold) {
                    var alertDirection = getDirection(userLat, userLon, alertCoord[0], alertCoord[1]);
                    nearbyInfo.push(alertName + ", " + alertDistance.toFixed(1) + "m, " + alertDirection.toFixed(0) + "°");
                }
            }

            // 多角形の情報を処理
            // 以下は多角形データの例。実際のpolygons.jsonからの座標データに合わせて処理します。
            var polygons = [{"name": "Polygon1", "coordinates": [[35.47652, 139.94972], [35.47373, 139.93805], [35.44856, 139.88037], [35.42394, 139.85909], [35.37805, 139.84741], [35.37469, 139.86458], [35.37469, 139.88106], [35.38141, 139.90509], [35.41947, 139.89342], [35.42674, 139.89479], [35.43513, 139.90166], [35.44744, 139.94354], [35.45975, 139.94766]], "popup": "9\u6708\u304b\u30895\u6708\u306b\u304b\u3051\u3066\u306f\u6728\u66f4\u6d25\u5e02\u6c96(\u76e4\u5dde)\u306e\u306e\u308a\u990a\u6b96\u65bd\u8a2d\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon2", "coordinates": [[35.68984, 139.9535], [35.67869, 139.9305], [35.67423, 139.92809], [35.62513, 139.95625], [35.62513, 139.95625], [35.64243, 139.98611]], "popup": "\u5e02\u5ddd\u6c34\u8def\u4ed8\u8fd1\u306f\u4e57\u63da(\u5ea7\u6d32)\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon3", "coordinates": [[35.66195, 139.92638], [35.64159, 139.94251], [35.63099, 139.92672], [35.62624, 139.93496], [35.63852, 139.98337], [35.64996, 139.98543], [35.66725, 139.9789], [35.67004, 139.95384]], "popup": "\u6c5f\u6238\u5ddd\u6c96\u3067\u306f\u306e\u308a\u990a\u6b96\u65bd\u8a2d\u306e\u640d\u50b7\u4e8b\u6545\u3084\u6d45\u702c\u3078\u306e\u4e57\u63da\u4e8b\u6545\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon4", "coordinates": [[35.63601, 139.84776], [35.62066, 139.84501], [35.61564, 139.8687], [35.62345, 139.8711], [35.63127, 139.87041]], "popup": "\u8352\u5ddd\u6cb3\u53e3\u4ed8\u8fd1\u3067\u306f\u4e57\u63da\u4e8b\u6545\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon5", "coordinates": [[35.49749, 139.7887], [35.44381, 139.69292], [35.42199, 139.68536], [35.39065, 139.72176], [35.46031, 139.82475]], "popup": "\u5f37\u98a8\u3084\u53f0\u98a8\u63a5\u8fd1\u6642\uff0c\u8d70\u9328\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon6", "coordinates": [[35.47093, 139.72656], [35.4645, 139.71249], [35.45024, 139.69498], [35.43821, 139.6888], [35.42786, 139.68536], [35.42674, 139.68193], [35.42311, 139.68124], [35.42199, 139.68021], [35.401, 139.7039], [35.44213, 139.74682]], "popup": "\u7279\u306b\u9db4\u898b\u822a\u8def\u3084\u6a2a\u6d5c\u822a\u8def\u306e\u51fa\u5165\u53e3\u4ed8\u8fd1\u3067\u306f\u6f01\u8239\u7b49\u3068\u306e\u885d\u7a81\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon7", "coordinates": [[35.31994, 139.81548], [35.34935, 139.79454], [35.31546, 139.76124], [35.28352, 139.80862], [35.30061, 139.82338], [35.31378, 139.78287]], "popup": "9\u6708\u304b\u30895\u6708\u306b\u304b\u3051\u3066\u306f\u6728\u66f4\u6d25\u5e02\u6c96(\u76e4\u5dde)\u4ed8\u8fd1\u53ca\u3073\u51a8\u6d25\u5cac\u4ed8\u8fd1\u306e\u306e\u308a\u7db2\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon8", "coordinates": [[35.27637, 139.71283], [35.26516, 139.713], [35.26446, 139.7233], [35.2667, 139.73051], [35.26586, 139.7336], [35.26404, 139.7324], [35.26306, 139.7336], [35.26404, 139.73566], [35.26053, 139.74236], [35.25675, 139.74613], [35.25339, 139.74665], [35.24974, 139.73824], [35.24778, 139.73806], [35.24652, 139.73635], [35.24091, 139.73309], [35.23796, 139.72485], [35.23081, 139.7324], [35.24203, 139.75746], [35.26067, 139.76072], [35.26712, 139.75626], [35.27651, 139.73583]], "popup": "\u89b3\u97f3\u5d0e\u4ed8\u8fd1\u3067\u306f\uff0c\u5c0f\u578b\u8239\u8236\uff0c\u7279\u306b\u30df\u30cb\u30dc\u30fc\u30c8\u3084\u624b\u6f15\u304e\u30dc\u30fc\u30c8\u3068\u306e\u885d\u7a81\u4e8b\u6545\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}, {"name": "Polygon9", "coordinates": [[35.27637, 139.71283], [35.27665, 139.73583], [35.26726, 139.75643], [35.26109, 139.76055], [35.25381, 139.76004], [35.24231, 139.75729], [35.23081, 139.7324], [35.23796, 139.72485], [35.24105, 139.73326], [35.2468, 139.73652], [35.24778, 139.73806], [35.24974, 139.73824], [35.25128, 139.74304], [35.25311, 139.74665], [35.25661, 139.74648], [35.26039, 139.74236], [35.26404, 139.73583], [35.26292, 139.7336], [35.26376, 139.73223], [35.266, 139.73377], [35.2667, 139.73068], [35.2646, 139.72364], [35.26502, 139.71334]], "popup": "\u89b3\u97f3\u5d0e\u4ed8\u8fd1\u3067\u306f\uff0c\u5c0f\u578b\u8239\u8236\uff0c\u7279\u306b\u30df\u30cb\u30dc\u30fc\u30c8\u3084\u624b\u6f15\u304e\u30dc\u30fc\u30c8\u3068\u306e\u885d\u7a81\u4e8b\u6545\u306b\u6ce8\u610f", "color": "red", "fill_opacity": 0.3}];
            for (var j = 0; j < polygons.length; j++) {
                var polygon = polygons[j];
                var polygonCoordinates = polygon.coordinates;  // 多角形の座標リスト
                var closestPoint = getClosestPoint(userLat, userLon, polygonCoordinates);
                var polygonDistance = getDistance(userLat, userLon, closestPoint[0], closestPoint[1]);
                if (polygonDistance <= distanceThreshold) {
                    var polygonDirection = getDirection(userLat, userLon, closestPoint[0], closestPoint[1]);
                    nearbyInfo.push("多角形: " + polygon.popup + ", " + polygonDistance.toFixed(1) + "m, " + polygonDirection.toFixed(0) + "°");
                }
            }

            // 画面左上に情報を表示
            document.getElementById("info-box").innerHTML = nearbyInfo.join("<br>");
        }

        // 2つの位置の距離を計算する関数 (Haversine formula)
        function getDistance(lat1, lon1, lat2, lon2) {
            var R = 6371000; // 地球の半径 (メートル)
            var φ1 = lat1 * Math.PI / 180;
            var φ2 = lat2 * Math.PI / 180;
            var Δφ = (lat2 - lat1) * Math.PI / 180;
            var Δλ = (lon2 - lon1) * Math.PI / 180;

            var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // メートルで返す
        }

        // 2つの位置の方向を計算する関数
        function getDirection(lat1, lon1, lat2, lon2) {
            var Δλ = (lon2 - lon1) * Math.PI / 180;
            var φ1 = lat1 * Math.PI / 180;
            var φ2 = lat2 * Math.PI / 180;

            var y = Math.sin(Δλ) * Math.cos(φ2);
            var x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            var θ = Math.atan2(y, x);
            var direction = (θ * 180 / Math.PI + 360) % 360;  // 方向を0-360度に変換
            return direction;
        }

        // 多角形の最も近い点を計算する関数
        function getClosestPoint(lat, lon, polygonCoordinates) {
            var closestPoint = null;
            var minDistance = Infinity;
            for (var i = 0; i < polygonCoordinates.length; i++) {
                var point = polygonCoordinates[i];
                var distance = getDistance(lat, lon, point[0], point[1]);
                if (distance < minDistance) {
                    closestPoint = point;
                    minDistance = distance;
                }
            }
            return closestPoint;
        }

        // ページが読み込まれた後に位置情報を取得
        window.onload = getUserLocation;
    </script>
</body>
</html>
